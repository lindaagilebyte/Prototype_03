<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>問診系統Prototype</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>問診系統Prototype</h1>

  <div id="status"></div>

  <!-- Admin-only reset button (separate row + color) -->
  <div class="admin-row">
    <button id="btnReset">重新產生顧客（管理用）</button>
  </div>

  <!-- Main row: game screen on the left, log on the right -->
  <div class="main-row">

    <!-- LEFT: game screen -->
    <div>
      <div id="gameScreen">
        <!-- Version label -->
        <div id="versionLabel"></div>

        <!-- Customer sprite: simple head + robe, bottom-center -->
        <div id="customerSprite">
          <!-- Body (robe) -->
          <div id="spriteBody">
            <!-- Left hand (semi-circle) -->
            <div id="spriteHandLeft"></div>
            <!-- Right hand (semi-circle) -->
            <div id="spriteHandRight"></div>
          </div>

          <!-- Head -->
          <div id="spriteHead">
            <div id="spriteMouth"></div>
          </div>

        </div>

        <!-- Gameplay UI layer: full overlay over the game screen -->
        <div id="uiLayer">
          <!-- Center area: placeholder buttons for now -->
          <div id="uiCenterButtons">
            <button id="btnSpawn"    class="gameButton">開始顧客來訪</button>
            <button id="btnClick"    class="gameButton">判定體質</button>
            <button id="btnDiagnose" class="gameButton">進行問診</button>
            <button id="btnLeave"    class="gameButton">顧客離開</button>
          </div>
        </div>


        <!-- Speech balloon for greetings (outside diagnosis overlay) -->
        <div id="greetingBalloon"></div>

        <!-- Diagnosis overlay (for 四診 phase) -->
        <div id="diagnosisOverlay" style="display: none;">
          <!-- Help button (top-left, diagnosis overlay only) -->
          <button id="btnDiagnosisHelp" class="diagnosisHelpButton" aria-label="Help">?</button>

          <!-- Inline help panel (inside diagnosis overlay; no new global overlay) -->
          <div id="diagnosisHelpPanel" aria-hidden="true">
            <div class="diagnosisHelpHeader">
              <div class="diagnosisHelpTitle">觀察顧客並進行診斷</div>
              <button id="btnDiagnosisHelpClose" class="diagnosisHelpClose" aria-label="Close">×</button>
            </div>
          
            <div class="diagnosisHelpBody">
              <div class="diagnosisHelpSection">
                <div class="diagnosisHelpSectionTitle">基本操作</div>
                <ul class="diagnosisHelpList">
                  <li>使用【望】、【聞】、【問】來觀察並詢問顧客</li>
                  <li>使用切來把脈</li>
                </ul>
              </div>
          
              <div class="diagnosisHelpSection">
                <div class="diagnosisHelpSectionTitle">信心值</div>
                <div class="diagnosisHelpText">所獲得的資訊會提升你對顧客需求的信心值（右側進度條）。</div>
                <div style="height:8px;"></div>
                <div class="diagnosisHelpText">當信心足夠時，畫面下方會出現【確認診斷】按鈕。</div>
          
                <!-- Preview of the real confirm button (visual only) -->
                <div style="margin-top: 8px; text-align: center;">
                  <button id="btnConfirmDiagnosisPreview" style="min-width: 200px; padding: 4px 8px; font-size: 16px; background: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; cursor: default;" type="button">確認診斷</button>
                </div>
              </div>
          
              <div class="diagnosisHelpSection">
                <div class="diagnosisHelpSectionTitle">提早判斷</div>
                <div class="diagnosisHelpText">另外，你也可以隨時按【拍板】提早判斷。不過，你的判斷可能有誤，最後給顧客的丹藥可能不適合顧客。</div>
              </div>
            </div>
          </div>
          
          

          <!-- Action buttons (問/切) above customer -->
          <div id="actionButtons">
            <button id="btnAsk" class="actionButton">問</button>
            <button id="btnPulse" class="actionButton">切</button>
          </div>

          <!-- Confidence bars on the right -->
          <div id="confidenceBars"></div>

          <!-- 拍板 button (commit diagnosis now) -->
          <button id="btnCommitDiagnosis" class="commitButton">拍板</button>

          <!-- Scattered clues container -->
          <div id="cluesContainer"></div>

          <!-- Speech balloon for 問 responses (inside diagnosis overlay) -->
          <div id="speechBalloon"></div>

          <!-- Question menu modal -->
          <div id="questionMenu">
            <div id="questionMenuContent">
              <h3>問診</h3>
              <div id="questionList"></div>
              <button id="btnCloseMenu">關閉</button>
            </div>
          </div>

          <!-- Confirm diagnosis button (appears when ready) -->
          <div id="diagnosisConfirmContainer">
            <button id="btnConfirmDiagnosis" class="gameButton">確認診斷</button>
          </div>
        </div>

        <!-- Popup overlay (on top of game screen) -->
        <div id="popupOverlay">

          <!-- Type confirmation popup -->
          <div id="typePopup">
            <div id="typePopupText"></div>
            <button id="btnTypeOk">確認</button>
          </div>

          <!-- Death notification popup -->
          <div id="deathPopup">
            <div id="deathPopupText"></div>
            <button id="btnDeathOk">確認</button>
          </div>

          <!-- Pulse/Toxicity popup -->
          <div id="pulsePopup">
            <div id="pulsePopupText"></div>
            <button id="btnPulseOk">確認</button>
          </div>

          <!-- Diagnosis Result popup -->
          <div id="diagnosisResultPopup">
            <h3>診斷結果</h3>
            <div id="diagnosisResultText"></div>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button id="btnDiagnosisResultExport">匯出</button>
              <button id="btnDiagnosisResultOk">確認</button>
            </div>
          </div>

          <!-- Diagnosis Selection UI (for 拍板) -->
          <div id="diagnosisSelectionUI">
            <h3>診斷選擇</h3>
            <div id="diagnosisSelectionContent">
              <div id="needsSelectionArea"></div>
              <div id="toxicityDisplayArea"></div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <button id="btnDiagnosisSelectionCancel">取消</button>
              <button id="btnDiagnosisSelectionConfirm">確認診斷</button>
            </div>
          </div>

          <!-- Handoff Screen (問診 → 煉丹) -->
          <div id="handoffScreen">
            <h3>問診流程已結束</h3>
            <div id="handoffContent">
              <p>下一步會進入 煉丹系統</p>
              <p>請先匯出問診結果，供外部煉丹Prototype使用。</p>
              
              <!-- Room ID Input Section -->
              <div style="margin-top: 16px; padding: 12px; background: #2a2a2a; border-radius: 4px;">
                <label for="roomIdInput" style="display: block; margin-bottom: 8px; font-weight: 600;">房間 ID (4位數)：</label>
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                  <input
                    type="text"
                    id="roomIdInput"
                    placeholder="例如：8888"
                    maxlength="4"
                    pattern="[0-9]{4}"
                    style="flex: 1; min-width: 120px; padding: 6px 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 3px; color: #fff; font-size: 14px;"
                  />
                  <button id="btnGenerateLink" style="padding: 6px 12px; background: #4a9eff; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">生成連結</button>
                </div>
                <div id="generatedLinkContainer" style="margin-top: 12px; display: none;">
                  <div style="margin-bottom: 8px; font-weight: 600;">生成的連結：</div>
                  <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <a
                      id="generatedLink"
                      href="#"
                      target="_blank"
                      rel="noopener noreferrer"
                      style="flex: 1; min-width: 200px; padding: 6px 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 3px; color: #4a9eff; text-decoration: none; word-break: break-all; font-size: 12px;"
                    ></a>
                    <button id="btnCopyLink" style="padding: 6px 12px; background: #666; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">複製</button>
                    <button id="btnOpenLink" style="padding: 6px 12px; background: #4a9eff; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">開啟</button>
                  </div>
                </div>
              </div>
              
              <p style="margin-top: 16px;">
                外部煉丹Prototype：
                <br>
                <a
                  id="alchemyPrototypeLink"
                  href="https://thirza0.github.io/ChineseAlchemy_Prototype/"
                  target="_blank"
                  rel="noopener noreferrer"
                  style="display:none;"
                >
                  https://thirza0.github.io/ChineseAlchemy_Prototype/
                </a>
              </p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
              <button id="btnHandoffExport">匯出問診結果</button>
              <button id="btnHandoffImport">Import pills</button>
            </div>
            
            <div id="handoffMessage" style="margin-top: 12px; text-align: center;"></div>
            
          </div>

          <!-- Post-Alchemy Feedback Screen -->
          <div id="postAlchemyScreen">
            <h3>治療結果</h3>
            <div id="postAlchemyContent">
              <p>顧客服用了丹藥。</p>
              <p>顧客的毒性已變化。下次可以用「切」確認。如果毒性很高，也會反映在膚色上。</p>
              <p>顧客對上一次治療的滿意度會表現在臉上。下次來訪時，觀察嘴型。</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <button id="btnPostAlchemyContinue">繼續</button>
            </div>
          </div>

          <!-- Alchemy Input UI -->
          <div id="alchemyInputUI">
            <h3>煉丹結果輸入</h3>
            <div id="alchemyInputContent">
              <div id="pillsContainer"></div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <button id="btnAlchemyInputConfirm">確認</button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- RIGHT: log, same height as game screen -->
    <pre id="log"></pre>

  </div>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script type="module" src="js/main.js"></script>
</body>
</html>
